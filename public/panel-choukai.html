<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kelola Latihan Mendengar (Choukai)</title><script src="https://cdn.tailwindcss.com"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script><link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><script>const THEME_KEY="theme-preference",htmlEl=document.documentElement,applyTheme=e=>{e==="dark"?htmlEl.classList.add("dark"):htmlEl.classList.remove("dark"),localStorage.setItem(THEME_KEY,e)},getPreferredTheme=()=>{const e=localStorage.getItem(THEME_KEY);return e||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")};applyTheme(getPreferredTheme());</script><script>tailwind.config={darkMode:"class"};</script><style>.ql-toolbar.ql-snow{border:1px solid #d4d4d4;border-top-left-radius:.5rem;border-top-right-radius:.5rem;background-color:#f5f5f4}.ql-container.ql-snow{border:1px solid #d4d4d4;border-bottom-left-radius:.5rem;border-bottom-right-radius:.5rem;background-color:#fff;min-height:150px}.dark .ql-toolbar.ql-snow{background-color:#292524;border-color:#44403c}.dark .ql-toolbar.ql-snow .ql-stroke{stroke:#d6d3d1}.dark .ql-toolbar.ql-snow .ql-fill{fill:#d6d3d1}.dark .ql-toolbar.ql-snow .ql-picker{color:#d6d3d1}.dark .ql-container.ql-snow{background-color:#1c1917;border-color:#44403c;color:#e5e5e5}</style></head><body class="bg-stone-50 dark:bg-stone-900 antialiased transition-colors duration-300"><nav class="bg-white dark:bg-stone-800 border-b border-stone-200 dark:border-stone-700 backdrop-blur-sm bg-white/90 dark:bg-stone-800/90 sticky top-0 z-10"><div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center"><div class="flex-1 min-w-0"><h1 class="text-lg font-semibold text-stone-900 dark:text-stone-100 tracking-tight">Kelola Choukai</h1><p id="chapter-title-display" class="text-sm text-stone-500 dark:text-stone-400 truncate">Memuat nama bab...</p></div><div class="flex items-center gap-3"><button id="theme-toggle-btn" class="p-2 rounded-full text-stone-600 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors"><i id="theme-icon-sun" class="fa-solid fa-sun text-xl"></i> <i id="theme-icon-moon" class="fa-solid fa-moon text-xl hidden"></i></button> <a href="/dashboard" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-200 bg-stone-100 dark:bg-stone-700 hover:bg-stone-200 dark:hover:bg-stone-600 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2 whitespace-nowrap">&larr; Kembali ke Dashboard</a></div></div></nav><main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12 max-w-5xl"><div class="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 shadow-sm p-6 sm:p-8 mb-8 transition-colors duration-300"><h2 id="form-title" class="text-xl font-semibold text-stone-900 dark:text-stone-100 mb-6 tracking-tight">Tambah Latihan Mendengar Baru</h2><form id="choukai-form" class="space-y-5"><input type="hidden" id="editingId" value=""><div><label for="title" class="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Judul Latihan</label> <input type="text" id="title" name="title" class="w-full px-4 py-2.5 text-sm text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-900 dark:focus:ring-stone-400 focus:border-transparent transition-all duration-200 placeholder:text-stone-400" placeholder="Mis: Percakapan di Stasiun" required></div><div><label class="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Deskripsi / Petunjuk Pengerjaan (Opsional)</label><div id="description-editor-container"></div></div><div><label for="image_url" class="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">URL Gambar (Opsional)</label> <input type="url" id="image_url" name="image_url" class="w-full px-4 py-2.5 text-sm text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-900 dark:focus:ring-stone-400 focus:border-transparent transition-all duration-200 placeholder:text-stone-400" placeholder="https://raw.githubusercontent.com/.../file.jpg"></div><div><label class="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">URL Audio</label><div id="audio-inputs-container" class="space-y-2"></div><button type="button" id="add-audio-btn" class="mt-2 inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-stone-700 dark:text-stone-200 bg-stone-100 dark:bg-stone-700 hover:bg-stone-200 dark:hover:bg-stone-600 rounded-md transition-colors duration-200 border border-stone-300 dark:border-stone-600">+ Tambah Audio</button></div><div><label class="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Teks Jawaban / Script (Opsional)</label><div id="script-editor-container"></div></div><div class="flex items-center gap-3"><button type="submit" id="submit-button" class="inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-stone-900 dark:bg-stone-100 dark:text-stone-900 hover:bg-stone-800 dark:hover:bg-stone-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2">Tambah Latihan</button> <button type="button" id="cancel-edit-button" class="hidden inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-stone-700 dark:text-stone-200 bg-stone-100 dark:bg-stone-700 hover:bg-stone-200 dark:hover:bg-stone-600 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2">Batal Edit</button></div></form></div><div class="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 shadow-sm p-6 sm:p-8 transition-colors duration-300"><h2 class="text-xl font-semibold text-stone-900 dark:text-stone-100 mb-6 tracking-tight">Daftar Latihan Choukai</h2><div id="list-container" class="space-y-3"><p class="text-sm text-stone-500 dark:text-stone-400">Memuat daftar latihan...</p></div></div></main><script>"use strict";var c=(n,t,e)=>new Promise((o,d)=>{var r=i=>{try{l(e.next(i))}catch(s){d(s)}},u=i=>{try{l(e.throw(i))}catch(s){d(s)}},l=i=>i.done?o(i.value):Promise.resolve(i.value).then(r,u);l((e=e.apply(n,t)).next())});const urlParams=new URLSearchParams(window.location.search),babId=urlParams.get("babId"),babTitle=urlParams.get("title");document.getElementById("chapter-title-display").textContent=babTitle?`Bab: ${babTitle}`:"Bab tidak ditemukan";const form=document.getElementById("choukai-form"),formTitle=document.getElementById("form-title"),submitButton=document.getElementById("submit-button"),cancelEditButton=document.getElementById("cancel-edit-button"),editingIdInput=document.getElementById("editingId"),listContainer=document.getElementById("list-container"),audioInputsContainer=document.getElementById("audio-inputs-container"),addAudioBtn=document.getElementById("add-audio-btn"),descriptionQuill=new Quill("#description-editor-container",{theme:"snow",modules:{toolbar:[[{header:[2,3,!1]}],["bold","italic","underline"],[{list:"ordered"},{list:"bullet"}],["clean"]]},placeholder:"Masukkan petunjuk pengerjaan choukai di sini..."}),scriptQuill=new Quill("#script-editor-container",{theme:"snow",modules:{toolbar:[[{header:[2,3,!1]}],["bold","italic","underline"],[{list:"ordered"},{list:"bullet"}],["clean"]]},placeholder:"Masukkan script atau jawaban choukai di sini..."}),showToast=(n,t="success")=>{Swal.fire({toast:!0,position:"top-end",icon:t,title:n,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,customClass:{popup:"dark:bg-stone-800 dark:text-white"}})};function addAudioInput(n=""){const t=audioInputsContainer.childElementCount===0,e=document.createElement("div");e.className="flex items-center gap-2 audio-input-row",e.innerHTML=`
                <input type="url" 
                    name="audio_urls" 
                    class="audio-url-input w-full px-4 py-2.5 text-sm text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-stone-900 dark:focus:ring-stone-400 placeholder:text-stone-400" 
                    placeholder="${t?"URL Audio (Wajib)":"URL Audio (Opsional)"}" 
                    value="${n}"
                    ${t?"required":""}> 
                
                ${t?"":`<button type="button" 
                        class="remove-audio-btn flex-shrink-0 px-3 py-2.5 text-sm font-medium text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" 
                        title="Hapus input">
                        &times;
                    </button>`}
            `,audioInputsContainer.appendChild(e)}addAudioBtn.addEventListener("click",()=>{addAudioInput("")}),audioInputsContainer.addEventListener("click",n=>{const t=n.target.closest(".remove-audio-btn");t&&t.closest(".audio-input-row").remove()});function fetchListeningExercises(){return c(this,null,function*(){if(!babId){listContainer.innerHTML='<p class="text-sm text-red-600 dark:text-red-400">Error: ID Bab tidak ditemukan.</p>';return}try{const n=yield fetch(`/api/admin/listening/${babId}`);if(!n.ok)throw new Error("Gagal mengambil data dari server");const t=yield n.json();renderListeningExercises(t)}catch(n){console.error("Error fetching choukai:",n),listContainer.innerHTML='<p class="text-sm text-red-600 dark:text-red-400">Gagal memuat latihan choukai.</p>'}})}function renderListeningExercises(n){if(listContainer.innerHTML="",n.length===0){listContainer.innerHTML='<p class="text-sm text-stone-500 dark:text-stone-400">Belum ada latihan choukai untuk bab ini.</p>';return}n.forEach(t=>{const e=document.createElement("div");e.className="border border-stone-200 dark:border-stone-700 rounded-lg p-4 hover:border-stone-300 dark:hover:border-stone-600 transition-colors duration-200";const o=t.audio_urls&&Array.isArray(t.audio_urls)?t.audio_urls.length:0;e.innerHTML=`
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <p class="text-base font-medium text-stone-900 dark:text-stone-100 truncate">${t.title||"Tanpa judul"}</p>
                            <p class="text-sm text-stone-600 dark:text-stone-400 truncate">${o} File Audio</p>
                        </div>
                        <div class="flex-shrink-0 flex gap-2">
                            <button class="edit-btn inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-stone-900 dark:bg-stone-100 dark:text-stone-900 hover:bg-stone-800 dark:hover:bg-stone-200 rounded-md" data-id="${t.id}">
                                Edit
                            </button>
                            <button class="delete-btn inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded-md" data-id="${t.id}">
                                Hapus
                            </button>
                        </div>
                    </div>
                `,listContainer.appendChild(e)})}function resetForm(){form.reset(),editingIdInput.value="",descriptionQuill.setContents([]),scriptQuill.setContents([]),audioInputsContainer.innerHTML="",addAudioInput(""),formTitle.textContent="Tambah Latihan Mendengar Baru",submitButton.textContent="Tambah Latihan",cancelEditButton.classList.add("hidden")}function editExercise(n){return c(this,null,function*(){try{const t=yield fetch(`/api/listening/entry/${n}`);if(!t.ok)throw new Error("Gagal mengambil data");const e=yield t.json();form.title.value=e.title||"",descriptionQuill.root.innerHTML=e.description||"",form.image_url.value=e.image_url||"",scriptQuill.root.innerHTML=e.script||"",editingIdInput.value=e.id,audioInputsContainer.innerHTML="",e.audio_urls&&e.audio_urls.length>0?e.audio_urls.forEach(o=>{o&&addAudioInput(o)}):addAudioInput(""),formTitle.textContent="Edit Latihan Mendengar",submitButton.textContent="Simpan Perubahan",cancelEditButton.classList.remove("hidden"),window.scrollTo({top:0,behavior:"smooth"}),form.title.focus()}catch(t){showToast(t.message,"error")}})}function deleteExercise(n){Swal.fire({title:"Anda yakin?",text:"Latihan mendengar ini akan dihapus permanen!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Ya, hapus!",cancelButtonText:"Batal",customClass:{popup:"dark:bg-stone-800 dark:text-white",title:"dark:text-white",content:"dark:text-gray-300"}}).then(t=>c(null,null,function*(){if(t.isConfirmed)try{if(!(yield fetch(`/api/listening/${n}`,{method:"DELETE"})).ok)throw new Error("Gagal menghapus");fetchListeningExercises(),showToast("Latihan berhasil dihapus."),resetForm()}catch(e){showToast(e.message,"error")}}))}form.addEventListener("submit",n=>c(null,null,function*(){n.preventDefault();const t=form.title.value,e=descriptionQuill.root.innerHTML,o=form.image_url.value||null,d=scriptQuill.root.innerHTML,r=audioInputsContainer.querySelectorAll(".audio-url-input"),u=Array.from(r).map(a=>a.value.trim()).filter(a=>a);if(u.length===0&&r.length>0&&r[0].value.trim()===""){showToast("URL Audio pertama (wajib) harus diisi.","error"),r[0].focus();return}const l=e==="<p><br></p>"?null:e,i=d==="<p><br></p>"?null:d,s=editingIdInput.value,m=!!s,h=m?"PUT":"POST",p=m?`/api/listening/${s}`:"/api/listening";try{const a=yield fetch(p,{method:h,headers:{"Content-Type":"application/json"},body:JSON.stringify({bab_id:babId,title:t,description:l,image_url:o,audio_urls:u,script:i})});if(!a.ok){const g=yield a.json();throw new Error(g.error||(m?"Gagal memperbarui":"Gagal menambah"))}resetForm(),fetchListeningExercises(),showToast(m?"Latihan berhasil diperbarui!":"Latihan berhasil ditambahkan!")}catch(a){showToast(a.message,"error")}})),listContainer.addEventListener("click",n=>{const t=n.target.closest("button");if(!t)return;const e=t.dataset.id;t.classList.contains("delete-btn")?deleteExercise(e):t.classList.contains("edit-btn")&&editExercise(e)}),cancelEditButton.addEventListener("click",resetForm);const themeToggleBtn=document.getElementById("theme-toggle-btn"),themeIconSun=document.getElementById("theme-icon-sun"),themeIconMoon=document.getElementById("theme-icon-moon"),updateThemeIcons=()=>{htmlEl.classList.contains("dark")?(themeIconSun.classList.add("hidden"),themeIconMoon.classList.remove("hidden")):(themeIconSun.classList.remove("hidden"),themeIconMoon.classList.add("hidden"))};updateThemeIcons(),themeToggleBtn.addEventListener("click",()=>{const n=htmlEl.classList.contains("dark");applyTheme(n?"light":"dark"),updateThemeIcons()}),document.addEventListener("DOMContentLoaded",()=>{fetchListeningExercises(),addAudioInput("")});</script></body></html>