<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kelola Latihan Membaca (Dokkai)</title><script src="https://cdn.tailwindcss.com"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script><link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script><style>.ql-toolbar.ql-snow{border:1px solid #d4d4d4;border-top-left-radius:.5rem;border-top-right-radius:.5rem;background-color:#f5f5f4}.ql-container.ql-snow{border:1px solid #d4d4d4;border-bottom-left-radius:.5rem;border-bottom-right-radius:.5rem;background-color:#fff;min-height:200px}.question-entry{position:relative;border:1px solid #e7e5e4;border-radius:.5rem;padding:1.5rem;background-color:#fafaf9}</style></head><body class="bg-stone-50 antialiased"><nav class="bg-white border-b border-stone-200 backdrop-blur-sm bg-white/90 sticky top-0 z-10"><div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center"><div class="flex-1 min-w-0"><h1 class="text-lg font-semibold text-stone-900 tracking-tight">Kelola Dokkai</h1><p id="chapter-title-display" class="text-sm text-stone-500 truncate">Memuat nama bab...</p></div><a href="/dashboard" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-stone-700 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2 whitespace-nowrap">&larr; Kembali ke Dashboard</a></div></nav><main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12 max-w-5xl"><div class="bg-white rounded-xl border border-stone-200 shadow-sm p-6 sm:p-8 mb-8"><h2 id="form-title" class="text-xl font-semibold text-stone-900 mb-6 tracking-tight">Tambah Wacana Dokkai Baru</h2><form id="dokkai-form" class="space-y-6"><input type="hidden" id="editingId" value=""><div><label for="passage_content" class="block text-sm font-medium text-stone-700 mb-2">Wacana (Passage)</label><div id="editor-container"></div></div><hr class="border-stone-200"><div><h3 class="text-lg font-semibold text-stone-800 mb-4">Pertanyaan</h3><div id="questions-container" class="space-y-6"></div></div><div><button type="button" id="add-question-btn" class="inline-flex items-center justify-center w-full px-5 py-2.5 text-sm font-medium text-stone-700 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2 border border-stone-300">+ Tambah Pertanyaan</button></div><hr class="border-stone-200 mt-8"><div class="flex items-center gap-3 pt-4"><button type="submit" id="submit-button" class="inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-stone-900 hover:bg-stone-800 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2">Tambah Wacana</button> <button type="button" id="cancel-edit-button" class="hidden inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-stone-700 bg-stone-100 hover:bg-stone-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2">Batal Edit</button></div></form></div><div class="bg-white rounded-xl border border-stone-200 shadow-sm p-6 sm:p-8"><h2 class="text-xl font-semibold text-stone-900 mb-6 tracking-tight">Daftar Wacana Dokkai</h2><div id="list-container" class="space-y-4"><p class="text-sm text-stone-500">Memuat daftar wacana...</p></div></div></main><script>"use strict";var f=(o,e,t)=>new Promise((a,s)=>{var p=i=>{try{x(t.next(i))}catch(n){s(n)}},b=i=>{try{x(t.throw(i))}catch(n){s(n)}},x=i=>i.done?a(i.value):Promise.resolve(i.value).then(p,b);x((t=t.apply(o,e)).next())});const urlParams=new URLSearchParams(window.location.search),babId=urlParams.get("babId"),babTitle=urlParams.get("title"),form=document.getElementById("dokkai-form"),formTitle=document.getElementById("form-title"),submitButton=document.getElementById("submit-button"),cancelEditButton=document.getElementById("cancel-edit-button"),editingIdInput=document.getElementById("editingId"),listContainer=document.getElementById("list-container"),questionsContainer=document.getElementById("questions-container"),addQuestionButton=document.getElementById("add-question-btn"),quill=new Quill("#editor-container",{theme:"snow",modules:{toolbar:[[{header:[2,3,!1]}],["bold","italic","underline"],[{list:"ordered"},{list:"bullet"}],["clean"]]},placeholder:"Masukkan wacana (passage) di sini..."}),showToast=(o,e="success")=>{Swal.fire({toast:!0,position:"top-end",icon:e,title:o,showConfirmButton:!1,timer:3e3,timerProgressBar:!0})};function addQuestionEntry(o={}){const e=questionsContainer.children.length+1,t=document.createElement("div");t.className="question-entry space-y-4",t.innerHTML=`
        <div class="flex justify-between items-center">
          <label class="block text-sm font-semibold text-stone-700">Pertanyaan ${e}</label>
          <button type="button" class="remove-question-btn text-sm font-medium text-red-600 hover:text-red-800" title="Hapus pertanyaan ini">Hapus</button>
        </div>
        
        <div>
          <label class="block text-xs font-medium text-stone-600 mb-1">Teks Pertanyaan</label>
          <textarea class="q-text w-full px-4 py-2.5 text-sm text-stone-900 bg-white border border-stone-300 rounded-lg" rows="2" placeholder="Masukkan teks pertanyaan" required>${o.question_text||""}</textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-stone-600 mb-1">Pilihan A</label>
            <input type="text" class="q-opt-a w-full px-4 py-2.5 text-sm text-stone-900 bg-white border border-stone-300 rounded-lg" value="${o.option_a||""}" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-stone-600 mb-1">Pilihan B</label>
            <input type="text" class="q-opt-b w-full px-4 py-2.5 text-sm text-stone-900 bg-white border border-stone-300 rounded-lg" value="${o.option_b||""}" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-stone-600 mb-1">Pilihan C</label>
            <input type="text" class="q-opt-c w-full px-4 py-2.5 text-sm text-stone-900 bg-white border border-stone-300 rounded-lg" value="${o.option_c||""}" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-stone-600 mb-1">Pilihan D</label>
            <input type="text" class="q-opt-d w-full px-4 py-2.5 text-sm text-stone-900 bg-white border border-stone-300 rounded-lg" value="${o.option_d||""}" required>
          </div>
        </div>
        
        <div>
          <label class="block text-xs font-medium text-stone-600 mb-1">Jawaban Benar</label>
          <select class="q-correct w-full md:w-1/2 px-4 py-2.5 text-sm text-stone-900 bg-white border border-stone-300 rounded-lg" required>
            <option value="" disabled>Pilih jawaban</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>
        </div>
      `,questionsContainer.appendChild(t),t.querySelector(".q-correct").value=o.correct_answer||""}function fetchReadingExercises(){return f(this,null,function*(){if(!babId){listContainer.innerHTML='<p class="text-sm text-red-600">Error: ID Bab tidak ditemukan.</p>';return}try{const o=yield fetch(`/api/admin/reading/${babId}`);if(!o.ok)throw new Error("Gagal memuat data");const e=yield o.json();renderReadingExercises(e)}catch(o){listContainer.innerHTML='<p class="text-sm text-red-600">Gagal memuat wacana dokkai.</p>',console.error(o)}})}function renderReadingExercises(o){if(listContainer.innerHTML="",o.length===0){listContainer.innerHTML='<p class="text-sm text-stone-500">Belum ada wacana dokkai untuk bab ini.</p>';return}o.forEach(e=>{const t=document.createElement("div");t.className="border border-stone-200 rounded-lg p-4 hover:border-stone-300 transition-colors duration-200";const a=document.createElement("div");a.innerHTML=e.passage_content;const s=a.textContent.substring(0,150)+"...",p=e.questions&&e.questions.length>0?e.questions.length:0;t.innerHTML=`
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex-1 min-w-0">
              <p class="text-xs font-medium text-stone-500">${p} Pertanyaan</p>
              <p class="text-sm text-stone-700 truncate" title="${a.textContent}">${s}</p>
            </div>
            <div class="flex-shrink-0 flex gap-2">
              <button class="edit-btn inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-stone-900 hover:bg-stone-800 rounded-md" data-id="${e.id}">Edit</button>
              <button class="delete-btn inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded-md" data-id="${e.id}">Hapus</button>
            </div>
          </div>
        `,listContainer.appendChild(t)})}function resetForm(){form.reset(),quill.setContents([]),questionsContainer.innerHTML="",editingIdInput.value="",formTitle.textContent="Tambah Wacana Dokkai Baru",submitButton.textContent="Tambah Wacana",cancelEditButton.classList.add("hidden"),addQuestionEntry()}function editExercise(o){return f(this,null,function*(){try{const e=yield fetch(`/api/reading/passage/${o}`);if(!e.ok)throw new Error("Gagal mengambil data wacana");const t=yield e.json();quill.root.innerHTML=t.passage_content,editingIdInput.value=t.id,questionsContainer.innerHTML="",t.questions&&t.questions.length>0&&t.questions.forEach(a=>addQuestionEntry(a)),formTitle.textContent="Edit Wacana Dokkai",submitButton.textContent="Simpan Perubahan",cancelEditButton.classList.remove("hidden"),window.scrollTo({top:0,behavior:"smooth"})}catch(e){showToast(e.message,"error")}})}function deleteExercise(o){Swal.fire({title:"Anda yakin?",text:"Wacana ini dan SEMUA pertanyaannya akan dihapus permanen!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Ya, hapus!",cancelButtonText:"Batal"}).then(e=>f(null,null,function*(){if(e.isConfirmed)try{if(!(yield fetch(`/api/reading/passage/${o}`,{method:"DELETE"})).ok)throw new Error("Gagal menghapus");fetchReadingExercises(),showToast("Wacana berhasil dihapus."),resetForm()}catch(t){showToast(t.message,"error")}}))}form.addEventListener("submit",o=>f(null,null,function*(){o.preventDefault();const e=quill.root.innerHTML,t=[],a=document.querySelectorAll(".question-entry");let s=!0;if(a.forEach(n=>{const r=n.querySelector(".q-text").value,l=n.querySelector(".q-opt-a").value,c=n.querySelector(".q-opt-b").value,d=n.querySelector(".q-opt-c").value,u=n.querySelector(".q-opt-d").value,m=n.querySelector(".q-correct").value;(!r||!l||!c||!d||!u||!m)&&(r||l||c||d||u||m)&&(s=!1),r&&t.push({question_text:r,option_a:l,option_b:c,option_c:d,option_d:u,correct_answer:m})}),t.length>0)a.forEach(n=>{const r=n.querySelector(".q-text").value;if(r){const l=n.querySelector(".q-opt-a").value,c=n.querySelector(".q-opt-b").value,d=n.querySelector(".q-opt-c").value,u=n.querySelector(".q-opt-d").value,m=n.querySelector(".q-correct").value;(!r||!l||!c||!d||!u||!m)&&(s=!1)}});else if(a.length>0&&!s){const n=a[0],r=n.querySelector(".q-text").value,l=n.querySelector(".q-opt-a").value,c=n.querySelector(".q-opt-b").value,d=n.querySelector(".q-opt-c").value,u=n.querySelector(".q-opt-d").value,m=n.querySelector(".q-correct").value;r||l||c||d||u||m?s=!1:s=!0}if(e==="<p><br></p>"){showToast("Wacana tidak boleh kosong","error");return}if(!s){showToast("Jika Anda menambahkan pertanyaan, semua kolomnya wajib diisi","error");return}const p=editingIdInput.value,b=!!p,x=b?"PUT":"POST",i=b?`/api/reading/passage/${p}`:"/api/reading/passage";try{const n=yield fetch(i,{method:x,headers:{"Content-Type":"application/json"},body:JSON.stringify({bab_id:babId,passage_content:e,questions:t})});if(!n.ok){const r=yield n.json();throw new Error(r.error||(b?"Gagal memperbarui":"Gagal menambah"))}resetForm(),fetchReadingExercises(),showToast(b?"Wacana berhasil diperbarui!":"Wacana berhasil ditambahkan!")}catch(n){showToast(n.message,"error"),console.error(n)}})),listContainer.addEventListener("click",o=>{const e=o.target.closest("button");if(!e)return;const t=e.dataset.id;e.classList.contains("delete-btn")?deleteExercise(t):e.classList.contains("edit-btn")&&editExercise(t)}),cancelEditButton.addEventListener("click",resetForm),addQuestionButton.addEventListener("click",()=>addQuestionEntry()),questionsContainer.addEventListener("click",o=>{o.target.classList.contains("remove-question-btn")&&(o.target.closest(".question-entry").remove(),document.querySelectorAll(".question-entry").forEach((e,t)=>{e.querySelector("label").textContent=`Pertanyaan ${t+1}`}))}),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("chapter-title-display").textContent=babTitle?`Bab: ${babTitle}`:"Bab tidak ditemukan",fetchReadingExercises(),addQuestionEntry()});</script></body></html>