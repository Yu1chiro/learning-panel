<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Kelola Latihan Membaca (Dokkai)</title><script src="https://cdn.tailwindcss.com"></script><script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script><link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet"><script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><script>const THEME_KEY="theme-preference",htmlEl=document.documentElement,applyTheme=e=>{e==="dark"?htmlEl.classList.add("dark"):htmlEl.classList.remove("dark"),localStorage.setItem(THEME_KEY,e)},getPreferredTheme=()=>{const e=localStorage.getItem(THEME_KEY);return e||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")};applyTheme(getPreferredTheme());</script><script>tailwind.config={darkMode:"class"};</script><style>.ql-toolbar.ql-snow{border:1px solid #d4d4d4;border-top-left-radius:.5rem;border-top-right-radius:.5rem;background-color:#f5f5f4}.ql-container.ql-snow{border:1px solid #d4d4d4;border-bottom-left-radius:.5rem;border-bottom-right-radius:.5rem;background-color:#fff;min-height:200px}.question-entry{position:relative;border:1px solid #e7e5e4;border-radius:.5rem;padding:1.5rem;background-color:#fafaf9}.dark .ql-toolbar.ql-snow{background-color:#292524;border-color:#44403c}.dark .ql-toolbar.ql-snow .ql-stroke{stroke:#d6d3d1}.dark .ql-toolbar.ql-snow .ql-fill{fill:#d6d3d1}.dark .ql-toolbar.ql-snow .ql-picker{color:#d6d3d1}.dark .ql-container.ql-snow{background-color:#1c1917;border-color:#44403c;color:#e5e5e5}.dark .question-entry{background-color:#292524;border-color:#44403c}</style></head><body class="bg-stone-50 dark:bg-stone-900 antialiased transition-colors duration-300"><nav class="bg-white dark:bg-stone-800 border-b border-stone-200 dark:border-stone-700 backdrop-blur-sm bg-white/90 dark:bg-stone-800/90 sticky top-0 z-10"><div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center"><div class="flex-1 min-w-0"><h1 class="text-lg font-semibold text-stone-900 dark:text-stone-100 tracking-tight">Kelola Dokkai</h1><p id="chapter-title-display" class="text-sm text-stone-500 dark:text-stone-400 truncate">Memuat nama bab...</p></div><div class="flex items-center gap-3"><button id="theme-toggle-btn" class="p-2 rounded-full text-stone-600 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-700 transition-colors"><i id="theme-icon-sun" class="fa-solid fa-sun text-xl"></i> <i id="theme-icon-moon" class="fa-solid fa-moon text-xl hidden"></i></button> <a href="/dashboard" class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium text-stone-700 dark:text-stone-200 bg-stone-100 dark:bg-stone-700 hover:bg-stone-200 dark:hover:bg-stone-600 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2 whitespace-nowrap">&larr; Kembali ke Dashboard</a></div></div></nav><main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12 max-w-5xl"><div class="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 shadow-sm p-6 sm:p-8 mb-8 transition-colors duration-300"><h2 id="form-title" class="text-xl font-semibold text-stone-900 dark:text-stone-100 mb-6 tracking-tight">Tambah Wacana Dokkai Baru</h2><form id="dokkai-form" class="space-y-6"><input type="hidden" id="editingId" value=""><div><label for="passage_content" class="block text-sm font-medium text-stone-700 dark:text-stone-300 mb-2">Wacana (Passage)</label><div id="editor-container"></div></div><hr class="border-stone-200 dark:border-stone-700"><div><h3 class="text-lg font-semibold text-stone-800 dark:text-stone-200 mb-4">Pertanyaan</h3><div id="questions-container" class="space-y-6"></div></div><div><button type="button" id="add-question-btn" class="inline-flex items-center justify-center w-full px-5 py-2.5 text-sm font-medium text-stone-700 dark:text-stone-200 bg-stone-100 dark:bg-stone-700 hover:bg-stone-200 dark:hover:bg-stone-600 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2 border border-stone-300 dark:border-stone-600">+ Tambah Pertanyaan</button></div><hr class="border-stone-200 dark:border-stone-700 mt-8"><div class="flex items-center gap-3 pt-4"><button type="submit" id="submit-button" class="inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-white bg-stone-900 dark:bg-stone-100 dark:text-stone-900 hover:bg-stone-800 dark:hover:bg-stone-200 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2">Tambah Wacana</button> <button type="button" id="cancel-edit-button" class="hidden inline-flex items-center justify-center px-5 py-2.5 text-sm font-medium text-stone-700 dark:text-stone-200 bg-stone-100 dark:bg-stone-700 hover:bg-stone-200 dark:hover:bg-stone-600 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-stone-900 focus:ring-offset-2">Batal Edit</button></div></form></div><div class="bg-white dark:bg-stone-800 rounded-xl border border-stone-200 dark:border-stone-700 shadow-sm p-6 sm:p-8 transition-colors duration-300"><h2 class="text-xl font-semibold text-stone-900 dark:text-stone-100 mb-6 tracking-tight">Daftar Wacana Dokkai</h2><div id="list-container" class="space-y-4"><p class="text-sm text-stone-500 dark:text-stone-400">Memuat daftar wacana...</p></div></div></main><script>"use strict";var g=(e,t,n)=>new Promise((a,s)=>{var b=i=>{try{x(n.next(i))}catch(o){s(o)}},p=i=>{try{x(n.throw(i))}catch(o){s(o)}},x=i=>i.done?a(i.value):Promise.resolve(i.value).then(b,p);x((n=n.apply(e,t)).next())});const urlParams=new URLSearchParams(window.location.search),babId=urlParams.get("babId"),babTitle=urlParams.get("title"),form=document.getElementById("dokkai-form"),formTitle=document.getElementById("form-title"),submitButton=document.getElementById("submit-button"),cancelEditButton=document.getElementById("cancel-edit-button"),editingIdInput=document.getElementById("editingId"),listContainer=document.getElementById("list-container"),questionsContainer=document.getElementById("questions-container"),addQuestionButton=document.getElementById("add-question-btn"),quill=new Quill("#editor-container",{theme:"snow",modules:{toolbar:[[{header:[2,3,!1]}],["bold","italic","underline"],[{list:"ordered"},{list:"bullet"}],["clean"]]},placeholder:"Masukkan wacana (passage) di sini..."}),showToast=(e,t="success")=>{Swal.fire({toast:!0,position:"top-end",icon:t,title:e,showConfirmButton:!1,timer:3e3,timerProgressBar:!0,customClass:{popup:"dark:bg-stone-800 dark:text-white"}})};function addQuestionEntry(e={}){const t=questionsContainer.children.length+1,n=document.createElement("div");n.className="question-entry space-y-4 transition-colors duration-300",n.innerHTML=`
        <div class="flex justify-between items-center">
          <label class="block text-sm font-semibold text-stone-700 dark:text-stone-300">Pertanyaan ${t}</label>
          <button type="button" class="remove-question-btn text-sm font-medium text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" title="Hapus pertanyaan ini">Hapus</button>
        </div>
        
        <div>
          <label class="block text-xs font-medium text-stone-600 dark:text-stone-400 mb-1">Teks Pertanyaan</label>
          <textarea class="q-text w-full px-4 py-2.5 text-sm text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 rounded-lg focus:ring-stone-900 dark:focus:ring-stone-400" rows="2" placeholder="Masukkan teks pertanyaan" required>${e.question_text||""}</textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-stone-600 dark:text-stone-400 mb-1">Pilihan A</label>
            <input type="text" class="q-opt-a w-full px-4 py-2.5 text-sm text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 rounded-lg focus:ring-stone-900 dark:focus:ring-stone-400" value="${e.option_a||""}" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-stone-600 dark:text-stone-400 mb-1">Pilihan B</label>
            <input type="text" class="q-opt-b w-full px-4 py-2.5 text-sm text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 rounded-lg focus:ring-stone-900 dark:focus:ring-stone-400" value="${e.option_b||""}" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-stone-600 dark:text-stone-400 mb-1">Pilihan C</label>
            <input type="text" class="q-opt-c w-full px-4 py-2.5 text-sm text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 rounded-lg focus:ring-stone-900 dark:focus:ring-stone-400" value="${e.option_c||""}" required>
          </div>
          <div>
            <label class="block text-xs font-medium text-stone-600 dark:text-stone-400 mb-1">Pilihan D</label>
            <input type="text" class="q-opt-d w-full px-4 py-2.5 text-sm text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 rounded-lg focus:ring-stone-900 dark:focus:ring-stone-400" value="${e.option_d||""}" required>
          </div>
        </div>
        
        <div>
          <label class="block text-xs font-medium text-stone-600 dark:text-stone-400 mb-1">Jawaban Benar</label>
          <select class="q-correct w-full md:w-1/2 px-4 py-2.5 text-sm text-stone-900 dark:text-stone-100 bg-white dark:bg-stone-700 border border-stone-300 dark:border-stone-600 rounded-lg focus:ring-stone-900 dark:focus:ring-stone-400" required>
            <option value="" disabled>Pilih jawaban</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>
        </div>
      `,questionsContainer.appendChild(n),n.querySelector(".q-correct").value=e.correct_answer||""}function fetchReadingExercises(){return g(this,null,function*(){if(!babId){listContainer.innerHTML='<p class="text-sm text-red-600">Error: ID Bab tidak ditemukan.</p>';return}try{const e=yield fetch(`/api/admin/reading/${babId}`);if(!e.ok)throw new Error("Gagal memuat data");const t=yield e.json();renderReadingExercises(t)}catch(e){listContainer.innerHTML='<p class="text-sm text-red-600 dark:text-red-400">Gagal memuat wacana dokkai.</p>',console.error(e)}})}function renderReadingExercises(e){if(listContainer.innerHTML="",e.length===0){listContainer.innerHTML='<p class="text-sm text-stone-500 dark:text-stone-400">Belum ada wacana dokkai untuk bab ini.</p>';return}e.forEach(t=>{const n=document.createElement("div");n.className="border border-stone-200 dark:border-stone-700 rounded-lg p-4 hover:border-stone-300 dark:hover:border-stone-600 transition-colors duration-200";const a=document.createElement("div");a.innerHTML=t.passage_content;const s=a.textContent.substring(0,150)+"...",b=t.questions&&t.questions.length>0?t.questions.length:0;n.innerHTML=`
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex-1 min-w-0">
              <p class="text-xs font-medium text-stone-500 dark:text-stone-400">${b} Pertanyaan</p>
              <p class="text-sm text-stone-700 dark:text-stone-300 truncate" title="${a.textContent}">${s}</p>
            </div>
            <div class="flex-shrink-0 flex gap-2">
              <button class="edit-btn inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-stone-900 dark:bg-stone-100 dark:text-stone-900 hover:bg-stone-800 dark:hover:bg-stone-200 rounded-md" data-id="${t.id}">Edit</button>
              <button class="delete-btn inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded-md" data-id="${t.id}">Hapus</button>
            </div>
          </div>
        `,listContainer.appendChild(n)})}function resetForm(){form.reset(),quill.setContents([]),questionsContainer.innerHTML="",editingIdInput.value="",formTitle.textContent="Tambah Wacana Dokkai Baru",submitButton.textContent="Tambah Wacana",cancelEditButton.classList.add("hidden"),addQuestionEntry()}function editExercise(e){return g(this,null,function*(){try{const t=yield fetch(`/api/reading/passage/${e}`);if(!t.ok)throw new Error("Gagal mengambil data wacana");const n=yield t.json();quill.root.innerHTML=n.passage_content,editingIdInput.value=n.id,questionsContainer.innerHTML="",n.questions&&n.questions.length>0&&n.questions.forEach(a=>addQuestionEntry(a)),formTitle.textContent="Edit Wacana Dokkai",submitButton.textContent="Simpan Perubahan",cancelEditButton.classList.remove("hidden"),window.scrollTo({top:0,behavior:"smooth"})}catch(t){showToast(t.message,"error")}})}function deleteExercise(e){Swal.fire({title:"Anda yakin?",text:"Wacana ini dan SEMUA pertanyaannya akan dihapus permanen!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Ya, hapus!",cancelButtonText:"Batal",customClass:{popup:"dark:bg-stone-800 dark:text-white",title:"dark:text-white",content:"dark:text-gray-300"}}).then(t=>g(null,null,function*(){if(t.isConfirmed)try{if(!(yield fetch(`/api/reading/passage/${e}`,{method:"DELETE"})).ok)throw new Error("Gagal menghapus");fetchReadingExercises(),showToast("Wacana berhasil dihapus."),resetForm()}catch(n){showToast(n.message,"error")}}))}form.addEventListener("submit",e=>g(null,null,function*(){e.preventDefault();const t=quill.root.innerHTML,n=[],a=document.querySelectorAll(".question-entry");let s=!0;if(a.forEach(o=>{const r=o.querySelector(".q-text").value,d=o.querySelector(".q-opt-a").value,c=o.querySelector(".q-opt-b").value,l=o.querySelector(".q-opt-c").value,u=o.querySelector(".q-opt-d").value,m=o.querySelector(".q-correct").value;(!r||!d||!c||!l||!u||!m)&&(r||d||c||l||u||m)&&(s=!1),r&&n.push({question_text:r,option_a:d,option_b:c,option_c:l,option_d:u,correct_answer:m})}),n.length>0)a.forEach(o=>{const r=o.querySelector(".q-text").value;if(r){const d=o.querySelector(".q-opt-a").value,c=o.querySelector(".q-opt-b").value,l=o.querySelector(".q-opt-c").value,u=o.querySelector(".q-opt-d").value,m=o.querySelector(".q-correct").value;(!r||!d||!c||!l||!u||!m)&&(s=!1)}});else if(a.length>0&&!s){const o=a[0],r=o.querySelector(".q-text").value,d=o.querySelector(".q-opt-a").value,c=o.querySelector(".q-opt-b").value,l=o.querySelector(".q-opt-c").value,u=o.querySelector(".q-opt-d").value,m=o.querySelector(".q-correct").value;r||d||c||l||u||m?s=!1:s=!0}if(t==="<p><br></p>"){showToast("Wacana tidak boleh kosong","error");return}if(!s){showToast("Jika Anda menambahkan pertanyaan, semua kolomnya wajib diisi","error");return}const b=editingIdInput.value,p=!!b,x=p?"PUT":"POST",i=p?`/api/reading/passage/${b}`:"/api/reading/passage";try{const o=yield fetch(i,{method:x,headers:{"Content-Type":"application/json"},body:JSON.stringify({bab_id:babId,passage_content:t,questions:n})});if(!o.ok){const r=yield o.json();throw new Error(r.error||(p?"Gagal memperbarui":"Gagal menambah"))}resetForm(),fetchReadingExercises(),showToast(p?"Wacana berhasil diperbarui!":"Wacana berhasil ditambahkan!")}catch(o){showToast(o.message,"error"),console.error(o)}})),listContainer.addEventListener("click",e=>{const t=e.target.closest("button");if(!t)return;const n=t.dataset.id;t.classList.contains("delete-btn")?deleteExercise(n):t.classList.contains("edit-btn")&&editExercise(n)}),cancelEditButton.addEventListener("click",resetForm),addQuestionButton.addEventListener("click",()=>addQuestionEntry()),questionsContainer.addEventListener("click",e=>{e.target.classList.contains("remove-question-btn")&&(e.target.closest(".question-entry").remove(),document.querySelectorAll(".question-entry").forEach((t,n)=>{t.querySelector("label").textContent=`Pertanyaan ${n+1}`}))});const themeToggleBtn=document.getElementById("theme-toggle-btn"),themeIconSun=document.getElementById("theme-icon-sun"),themeIconMoon=document.getElementById("theme-icon-moon"),updateThemeIcons=()=>{htmlEl.classList.contains("dark")?(themeIconSun.classList.add("hidden"),themeIconMoon.classList.remove("hidden")):(themeIconSun.classList.remove("hidden"),themeIconMoon.classList.add("hidden"))};updateThemeIcons(),themeToggleBtn.addEventListener("click",()=>{const e=htmlEl.classList.contains("dark");applyTheme(e?"light":"dark"),updateThemeIcons()}),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("chapter-title-display").textContent=babTitle?`Bab: ${babTitle}`:"Bab tidak ditemukan",fetchReadingExercises(),addQuestionEntry()});</script></body></html>